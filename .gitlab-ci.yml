image: docker:latest
services:
- docker:dind

docker_image:
  stage: build
  script:
  - export VERSION=$(cat version.txt)
  - echo "Building image version ${VERSION}."
  - docker login registry.gitlab.com -u gitlab-ci-token -p $CI_BUILD_TOKEN
  - docker pull "registry.gitlab.com/${CI_PROJECT_PATH}:latest" || true
  - docker build --build-arg "VERSION=${VERSION}" -t "${CI_PROJECT_NAME}:${VERSION}" .
  - docker tag "${CI_PROJECT_NAME}:${VERSION}" "registry.gitlab.com/${CI_PROJECT_PATH}:${VERSION}"
  - docker tag "${CI_PROJECT_NAME}:${VERSION}" "registry.gitlab.com/${CI_PROJECT_PATH}:latest"
  - docker push "registry.gitlab.com/${CI_PROJECT_PATH}:${VERSION}"
  - docker push "registry.gitlab.com/${CI_PROJECT_PATH}:latest"
  tags:
  - shared
  - linux
  - docker

push_dockerhub:
  stage: deploy
  script:
  - export VERSION=$(cat version.txt)
  - docker pull "registry.gitlab.com/${CI_PROJECT_PATH}:${VERSION}"
  - docker tag "registry.gitlab.com/${CI_PROJECT_PATH}:${VERSION}" "index.docker.io/${CI_PROJECT_PATH}:${VERSION}"
  - docker tag "registry.gitlab.com/${CI_PROJECT_PATH}:${VERSION}" "index.docker.io/${CI_PROJECT_PATH}:latest"
  - docker push "index.docker.io/${CI_PROJECT_PATH}:${VERSION}"
  - docker push "index.docker.io/${CI_PROJECT_PATH}:latest"
  tags:
  - shared
  - linux
  - docker
